<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <title>Funding History Viewer</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <style>
         :root {
        --bg-color: #ffffff;
        --text-color: #000000;
        --card-color: #ffffff;
        --input-bg: #ffffff;
        --input-border: #000000;
        --button-bg: #008b20;
        --button-hover: #005815;
        --chart-line: #3f8d00;
        --bg-overlay: #e1e1e1bf;
        --box-shadow: rgba(0, 0, 0, 0.6);
        --chart-text: #000000;
        --grid-color: rgba(0, 0, 0, 0.1);
        --highlight-bg: #e0f2fe;
      }

      body.dark {
        --bg-color: #000000;
        --text-color: #ffffff;
        --card-color: #000000;
        --input-bg: #000000;
        --input-border: #ffffff;
        --button-bg: #008b20;
        --button-hover: #005815;
        --chart-line: #3f8d00;
        --bg-overlay: #1e1e1ebf;
        --box-shadow: rgba(255, 255, 255, 0.6);
        --chart-text: #ffffff;
        --grid-color: rgba(255, 255, 255, 0.2);
      }

      body {
        font-family: Arial, sans-serif;
        padding: 2rem;
        max-width: 1000px;
        margin: auto;
        background: var(--bg-color);
        color: var(--text-color);
        transition: background 0.3s, color 0.3s;
      }

      h2 {
        margin-bottom: 1.5rem;
      }

      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        cursor: pointer;
        font-size: 1.5rem;
        user-select: none;
      }

      /* Controls & layout */
      .controls {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        background: var(--card-color);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 6px var(--box-shadow);
        margin-bottom: 2rem;
      }

      .row {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .row.vertical-stack {
        flex-direction: column;
        gap: 2rem;
        align-items: center;
      }

      .control-group {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 250px;
        max-width: 100%;
      }

      /* Token dropdown */
      .token-selector {
        position: relative;
        width: 100%;
      }

      .dropdown {
        width: 100%;
        position: relative;
        border: 1px solid var(--input-border);
        border-radius: 0.75rem;
        background: var(--input-bg);
        color: var(--text-color);
        box-shadow: 0 2px 4px var(--box-shadow);
        box-sizing: border-box;
        min-height: 48px;
      }

      .selected {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0.75rem;
        width: 100%;
        box-sizing: border-box;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .selected:hover {
        background: #f3f4f6;
      }

      .arrow {
        transition: transform 0.3s ease;
        display: inline-block;
      }

      .arrow.open {
        transform: rotate(180deg);
      }

      .dropdown-list {
        display: none;
        position: absolute;
        width: 100%;
        background: var(--card-color);
        border-radius: 0.75rem;
        margin-top: 0.25rem;
        border: 1px solid var(--input-border);
        max-height: 320px;
        overflow-y: auto;
        z-index: 20;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
        box-sizing: border-box;
      }

      /* Search input inside dropdown */
      .search-input {
        width: 100%;
        padding: 0.5rem 1rem;
        border: none;
        border-bottom: 1px solid var(--input-border);
        outline: none;
        box-sizing: border-box;
        font-size: 1rem;
        border-radius: 0;
      }

      /* Dropdown items */
      .dropdown-item {
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
        width: 100%;
        box-sizing: border-box;
        cursor: pointer;
      }

      .dropdown-item:hover {
        background: #f3f4f6;
      }

      .dropdown-item.selected-token {
        background-color: var(--highlight-bg);
        font-weight: 600;
      }

      .dropdown-item span:first-child {
        flex-grow: 1;
      }

      .star {
        cursor: pointer;
        font-size: 1rem;
        transition: transform 0.2s ease;
      }

      .star:hover {
        transform: scale(1.2);
      }

      .section-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: #6b7280;
        padding: 0.5rem 1rem 0.25rem;
        background-color: var(--card-color);
      }

      /* Dataset dropdown options */
      .dataset-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
      }

      .dataset-option:hover {
        background: #f3f4f6;
      }

      .dataset-option span {
        flex-grow: 1;
        font-size: 1rem;
      }

      /* Inputs, buttons, spinners */
      input, select, button {
        padding: 0.6rem;
        font-size: 16px;
        background: var(--input-bg);
        color: var(--text-color);
        border: 1px solid var(--input-border);
        border-radius: 6px;
      }

      button {
        background-color: var(--button-bg);
        color: white;
        cursor: pointer;
        border: none;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: var(--button-hover);
      }

      canvas {
        max-width: 100%;
      }

      .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background-color: var(--bg-overlay);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        display: none;
      }

      .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid var(--button-bg);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Quick range and custom range controls */
      .quick-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        width: 100%;
        margin-top: 0.5rem;
      }

      .custom-range-inputs {
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
      }

      .custom-range-inputs input {
        width: 100%;
        max-width: 320px;
      }

      /* MA stats table */
      .ma-stats-table {
        width: 100%;
        margin: 1.5rem 0;
        font-size: 0.95rem;
      }

      .ma-stats-table table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
        background-color: var(--card-color);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 1px 4px var(--box-shadow);
      }

      .ma-stats-table th,
      .ma-stats-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--input-border);
      }

      .ma-stats-table th {
        background-color: var(--card-bg-hover);
        font-weight: 600;
      }

      #maStatsTable-MA-Range { border-color: red; }
      #maStatsTable-MA-24h { border-color: orange; }
      #maStatsTable-MA-3D { border-color: blue; }
      #maStatsTable-MA-7D { border-color: pink; }
      #maStatsTable-MA-30D { border-color: purple; }

      .ma-footnote {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        text-align: right;
        opacity: 0.7;
      }

      /* Responsive adjustments */
      @media (max-width: 1023px) {
        .row {
          flex-direction: column;
          gap: 1rem;
        }

        .dropdown {
          width: 100%;
        }

        .dropdown-list {
          left: 0;
          right: 0;
          width: auto;
          min-width: 100%;
          box-sizing: border-box;
        }
        .controls {
          padding: 1rem;
          gap: 1rem;
        }

        .control-group label {
          font-size: 0.95rem;
        }

        .selected {
          font-size: 0.95rem;
        }

        .control-group {
          min-width: 100%;
          max-width: 100%;
        }
      }
      </style>
   </head>
   <body>
      <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">🌙</div>
      <h2>Hyperliquid Funding History</h2>
      <div id="spinnerOverlay" class="spinner-overlay">
         <div class="spinner"></div>
      </div>
      <div class="controls">
         <div class="row">
            <div class="control-group">
              <label for="dropdown"><strong>Select Token:</strong></label>
              <div class="token-selector">
                <div class="dropdown" id="dropdown">
                  <div class="selected" onclick="toggleDropdown(event)">
                    <span id="selectedTokenLabel">Select Token</span>
                    <span class="arrow" id="dropdownArrow">▾</span>
                  </div>
                  <div class="dropdown-list" id="dropdownList"></div>
                </div>
              </div>
            </div>
            <div class="control-group">
               <label><strong>View Mode:</strong></label>
                <div class="token-selector">
                  <div class="dropdown" id="viewModeDropdown">
                    <div class="selected" onclick="toggleViewModeDropdown(event)">
                      <span id="selectedViewModeLabel">Hourly</span>
                      <span class="arrow" id="viewModeDropdownArrow">▾</span>
                    </div>
                    <div class="dropdown-list" id="viewModeDropdownList">
                      <div class="dropdown-item" onclick="selectViewMode('hourly')">Hourly</div>
                      <div class="dropdown-item" onclick="selectViewMode('annualized')">Annualized</div>
                    </div>
                  </div>
                </div>
            </div>
            <div class="control-group dataset-control">
              <label><strong>Datasets:</strong></label>
              <div class="token-selector">
                <div class="dropdown" id="datasetDropdown">
                  <div class="selected" onclick="toggleDatasetDropdown(event)">
                    <span id="datasetDropdownLabel">Select datasets</span>
                    <span class="arrow" id="datasetDropdownArrow">▾</span>
                  </div>
                  <div class="dropdown-list" id="datasetDropdownList">
                    <!-- items populated dynamically by JS -->
                  </div>
                </div>
              </div>
            </div>
         </div>
      </div>
      <div class="controls">
         <div class="row vertical-stack">
            <div class="quick-range">
               <label><strong>Quick Ranges:</strong></label>
               <div class="quick-buttons">
                  <button onclick="applyQuickRange('1d')">Last 24 Hours</button>
                  <button onclick="applyQuickRange('3d')">Last 3 Days</button>
                  <button onclick="applyQuickRange('7d')">Last 7 Days</button>
                  <button onclick="applyQuickRange('30d')">Last 30 Days</button>
               </div>
            </div>
            <div class="custom-range">
               <label><strong>Custom Range:</strong></label>
               <div class="custom-range-inputs">
                  <input type="datetime-local" id="customStart" />
                  <span>-</span>
                  <input type="datetime-local" id="customEnd" />
               </div>
               <button onclick="loadFundingData('custom')">Load</button>
            </div>
         </div>
      </div>
      <div id="maStatsTable" class="ma-stats-table">
         <table>
            <thead>
               <tr>
                  <th id="maStatsTable-MA-Range">MA (Range)</th>
                  <th id="maStatsTable-MA-24h">MA (24h)</th>
                  <th id="maStatsTable-MA-3D">MA (3D)</th>
                  <th id="maStatsTable-MA-7D">MA (7D)</th>
                  <th id="maStatsTable-MA-30D">MA (30D)</th>
               </tr>
            </thead>
            <tbody>
               <tr id="maValuesRow"></tr>
            </tbody>
         </table>
         <div class="ma-footnote">* MA = Moving Average</div>
      </div>
      <canvas id="fundingChart" width="800" height="400"></canvas>
      <script>
      let allTokens = [];
      let favorites = JSON.parse(localStorage.getItem('favoriteTokens') || '[]');
      let selectedToken = localStorage.getItem('selectedToken') || null;
      let fundingChart = null;

      // ===================
      // Token Dropdown
      // ===================

      async function fetchAndRenderTokens() {
        const response = await fetch('https://api.hyperliquid.xyz/info', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'meta' }),
        });
        const meta = await response.json();
        allTokens = meta.universe.map(t => t.name);
        renderDropdown();
      }

      function toggleDropdown(event) {
        event.stopPropagation();
        const list = document.getElementById('dropdownList');
        const arrow = document.getElementById('dropdownArrow');

        const isOpen = list.style.display === 'block';
        if (isOpen) {
          list.style.display = 'none';
          arrow.classList.remove('open');
        } else {
          closeAllDropdowns();
          list.style.display = 'block';
          arrow.classList.add('open');

          const input = document.createElement('input');
          input.type = 'text';
          input.id = 'searchInput';
          input.className = 'search-input';
          input.placeholder = 'Search token...';
          input.oninput = filterTokens;

          list.innerHTML = '';
          list.appendChild(input);
          filterTokens();
          setTimeout(() => input.focus(), 0);
        }
      }

      function filterTokens() {
        const list = document.getElementById('dropdownList');
        const input = document.getElementById('searchInput');
        const query = input.value.toLowerCase();

        while (list.children.length > 1) {
          list.removeChild(list.lastChild);
        }

        const filteredFavorites = favorites.filter(
          t => allTokens.includes(t) && t.toLowerCase().includes(query)
        );
        const filteredOthers = allTokens
          .filter(t => !favorites.includes(t))
          .filter(t => t.toLowerCase().includes(query));

        if (filteredFavorites.length > 0) {
          list.appendChild(createLabel('★ Favorites'));
          filteredFavorites.forEach(token => list.appendChild(createDropdownItem(token)));
        }

        if (filteredOthers.length > 0) {
          list.appendChild(createLabel('All Tokens'));
          filteredOthers.forEach(token => list.appendChild(createDropdownItem(token)));
        }

        if (filteredFavorites.length === 0 && filteredOthers.length === 0) {
          const noResults = document.createElement('div');
          noResults.className = 'dropdown-item';
          noResults.textContent = 'No tokens found';
          list.appendChild(noResults);
        }
      }

      function renderDropdown() {
        const label = document.getElementById('selectedTokenLabel');
        if (selectedToken) label.innerText = selectedToken;
      }

      function createLabel(text) {
        const label = document.createElement('div');
        label.className = 'section-label';
        label.textContent = text;
        return label;
      }

      function createDropdownItem(token) {
        const item = document.createElement('div');
        item.className = 'dropdown-item' + (token === selectedToken ? ' selected-token' : '');
        item.onclick = () => selectToken(token);

        const nameSpan = document.createElement('span');
        nameSpan.textContent = token;

        const starSpan = document.createElement('span');
        starSpan.className = 'star';
        starSpan.textContent = favorites.includes(token) ? '★' : '☆';
        starSpan.onclick = (e) => toggleFavorite(e, token);

        item.appendChild(nameSpan);
        item.appendChild(starSpan);
        return item;
      }

      function selectToken(token) {
        selectedToken = token;
        document.getElementById('selectedTokenLabel').innerText = token;
        localStorage.setItem('selectedToken', token);
        document.getElementById('dropdownList').style.display = 'none';
        document.getElementById('dropdownArrow').classList.remove('open');
        renderDropdown();
        loadFundingData('custom');
      }

      function toggleFavorite(e, token) {
        e.stopPropagation();
        const index = favorites.indexOf(token);
        if (index >= 0) favorites.splice(index, 1);
        else favorites.push(token);
        localStorage.setItem('favoriteTokens', JSON.stringify(favorites));
        filterTokens();
      }

      // ===================
      // View Mode Dropdown
      // ===================

      function toggleViewModeDropdown(event) {
        event.stopPropagation();
        const list = document.getElementById('viewModeDropdownList');
        const arrow = document.getElementById('viewModeDropdownArrow');
        const isOpen = list.style.display === 'block';

        if (isOpen) {
          list.style.display = 'none';
          arrow.classList.remove('open');
        } else {
          closeAllDropdowns();
          list.style.display = 'block';
          arrow.classList.add('open');
        }
      }

      function selectViewMode(mode) {
        const label = document.getElementById('selectedViewModeLabel');
        label.innerText = mode.charAt(0).toUpperCase() + mode.slice(1);
        localStorage.setItem('viewMode', mode);
        document.getElementById('viewModeDropdownList').style.display = 'none';
        document.getElementById('viewModeDropdownArrow').classList.remove('open');
        loadFundingData('custom');
      }

      // ===================
      // Dataset Dropdown + Checkbox Sync
      // ===================

      function toggleDatasetDropdown(event) {
        event.stopPropagation();
        const list = document.getElementById('datasetDropdownList');
        const arrow = document.getElementById('datasetDropdownArrow');
        const isOpen = list.style.display === 'block';

        if (isOpen) {
          list.style.display = 'none';
          arrow.classList.remove('open');
        } else {
          closeAllDropdowns();
          list.style.display = 'block';
          arrow.classList.add('open');
        }
      }

      function buildDatasetDropdown() {
        const list = document.getElementById('datasetDropdownList');
        list.innerHTML = '';

        const datasets = [
          'Funding Rate', 'MA (Range)', 'MA (24h)', 'MA (3D)', 'MA (7D)', 'MA (30D)'
        ];

        const savedVisibility = JSON.parse(localStorage.getItem('datasetVisibility') || '{}');

        datasets.forEach(label => {
          const labelWrapper = document.createElement('label');
          labelWrapper.className = 'dropdown-item dataset-option';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'dataset-checkbox';
          checkbox.checked = savedVisibility[label] !== false;
          checkbox.onchange = () => {
            toggleDatasetVisibility(label, checkbox.checked);
            updateDatasetLabel();
          };

          const text = document.createElement('span');
          text.textContent = label;

          labelWrapper.appendChild(checkbox);
          labelWrapper.appendChild(text);
          list.appendChild(labelWrapper);
        });

        updateDatasetLabel();
      }

      function updateDatasetLabel() {
        const checkboxes = document.querySelectorAll('.dataset-checkbox');
        const checked = Array.from(checkboxes).filter(c => c.checked);
        const label = document.getElementById('datasetDropdownLabel');
        const count = checked.length;
        label.innerText = `${count} dataset${count !== 1 ? 's' : ''} selected`;
      }

      function toggleDatasetVisibility(label, visible) {
        if (!fundingChart) return;
        fundingChart.data.datasets.forEach((dataset, i) => {
          const datasetLabel = dataset.label.startsWith('Funding Rate') ? 'Funding Rate' : dataset.label;
          if (datasetLabel === label) {
            fundingChart.getDatasetMeta(i).hidden = !visible;
          }
        });
        fundingChart.update();

        const currentVisibility = JSON.parse(localStorage.getItem('datasetVisibility') || '{}');
        currentVisibility[label] = visible;
        localStorage.setItem('datasetVisibility', JSON.stringify(currentVisibility));
      }

      function syncDatasetCheckboxes() {
        const checkboxes = document.querySelectorAll('.dataset-checkbox');
        checkboxes.forEach(checkbox => {
          const label = checkbox.nextSibling.textContent.trim();
          const chartDataset = fundingChart.data.datasets.find(ds => {
            const datasetLabel = ds.label.startsWith('Funding Rate') ? 'Funding Rate' : ds.label;
            return datasetLabel === label;
          });
          if (chartDataset) {
            const meta = fundingChart.getDatasetMeta(fundingChart.data.datasets.indexOf(chartDataset));
            checkbox.checked = !meta.hidden;
          }
        });
        updateDatasetLabel();
      }

      // ===================
      // Global Dropdown Close Handler
      // ===================

      function closeAllDropdowns() {
        document.getElementById('dropdownList').style.display = 'none';
        document.getElementById('dropdownArrow').classList.remove('open');
        document.getElementById('viewModeDropdownList').style.display = 'none';
        document.getElementById('viewModeDropdownArrow').classList.remove('open');
        document.getElementById('datasetDropdownList').style.display = 'none';
        document.getElementById('datasetDropdownArrow').classList.remove('open');
      }

      document.addEventListener('click', function (event) {
        if (!event.target.closest('.dropdown')) {
          closeAllDropdowns();
        }
      });

     // Funding data loading and chart rendering
      async function loadFundingData(range = '7d') {
        const token = localStorage.getItem('selectedToken') || 'BTC';
        const viewMode = localStorage.getItem('viewMode') || 'hourly';
        const precision = (viewMode === 'annualized') ? 2 : 4;

        let startTime, endTime = Date.now();

        if (range === 'custom') {
          const startStr = document.getElementById('customStart').value;
          const endStr = document.getElementById('customEnd').value;
          if (!startStr || !endStr) {
            alert('Please select both start and end dates.');
            return;
          }
          startTime = new Date(startStr).getTime();
          endTime = new Date(endStr).getTime();
          if (startTime >= endTime) {
            alert('Start time must be before end time.');
            return;
          }
        } else {
          applyQuickRange(range);
          return;
        }

        const bufferMs = 30 * 24 * 60 * 60 * 1000;
        const fetchStartTime = startTime - bufferMs;
        const maxChunkMs = 20 * 24 * 60 * 60 * 1000;
        const chunks = [];
        for (let chunkStart = fetchStartTime; chunkStart < endTime; chunkStart += maxChunkMs) {
          chunks.push([chunkStart, Math.min(chunkStart + maxChunkMs, endTime)]);
        }

        toggleSpinner(true);

        try {
          const fetches = chunks.map(([start, end]) =>
            fetch('https://api.hyperliquid.xyz/info', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                type: 'fundingHistory',
                coin: token,
                startTime: start,
                endTime: end,
              }),
            }).then(res => res.json())
          );

          const chunkDataArrays = await Promise.all(fetches);
          const combinedData = chunkDataArrays.flat().sort((a, b) => a.time - b.time);

          const visibleData = combinedData.filter(d => d.time >= startTime && d.time <= endTime);
          const labels = visibleData.map(item => new Date(item.time).toLocaleString());
          let fundingValues = visibleData.map(item => parseFloat(item.fundingRate) * 100);

          if (viewMode === 'annualized') {
            fundingValues = fundingValues.map(val => val * 24 * 365);
          }

          const cumulativeMovingAvg = fundingValues.reduce((acc, val, idx) => {
            const newSum = (acc.sum || 0) + val;
            acc.movingAvg.push(newSum / (idx + 1));
            acc.sum = newSum;
            return acc;
          }, { movingAvg: [], sum: 0 }).movingAvg;

          const fullFundingValues = combinedData.map(item =>
            viewMode === 'annualized'
              ? parseFloat(item.fundingRate) * 100 * 24 * 365
              : parseFloat(item.fundingRate) * 100
          );
          const fullTimestamps = combinedData.map(item => item.time);

          const ma24h = calculateMovingAverage(fullTimestamps, fullFundingValues, 24 * 60 * 60 * 1000);
          const ma3d = calculateMovingAverage(fullTimestamps, fullFundingValues, 3 * 24 * 60 * 60 * 1000);
          const ma7d = calculateMovingAverage(fullTimestamps, fullFundingValues, 7 * 24 * 60 * 60 * 1000);
          const ma30d = calculateMovingAverage(fullTimestamps, fullFundingValues, 30 * 24 * 60 * 60 * 1000);

          const lastVisibleIndex = fullTimestamps.findLastIndex(t => t <= endTime);

          const filteredMA24h = filterVisibleMovingAverage(fullTimestamps, ma24h, visibleData.map(d => d.time));
          const filteredMA3d  = filterVisibleMovingAverage(fullTimestamps, ma3d, visibleData.map(d => d.time));
          const filteredMA7d  = filterVisibleMovingAverage(fullTimestamps, ma7d, visibleData.map(d => d.time));
          const filteredMA30d = filterVisibleMovingAverage(fullTimestamps, ma30d, visibleData.map(d => d.time));

          const style = getComputedStyle(document.body);
          const lineColor = style.getPropertyValue('--chart-line').trim();
          const textColor = style.getPropertyValue('--chart-text').trim();
          const gridColor = style.getPropertyValue('--grid-color').trim();

          const savedVisibility = JSON.parse(localStorage.getItem('datasetVisibility') || '{}');

          const datasets = [
            { label: 'MA (Range)', data: cumulativeMovingAvg, borderColor: 'red', borderDash: [4, 2], hidden: savedVisibility['MA (Range)'] === false },
            { label: 'MA (24h)', data: filteredMA24h, borderColor: 'orange', borderDash: [2, 2], hidden: savedVisibility['MA (24h)'] === false },
            { label: 'MA (3D)', data: filteredMA3d, borderColor: 'blue', borderDash: [2, 2], hidden: savedVisibility['MA (3D)'] === false },
            { label: 'MA (7D)', data: filteredMA7d, borderColor: 'pink', borderDash: [2, 2], hidden: savedVisibility['MA (7D)'] === false },
            { label: 'MA (30D)', data: filteredMA30d, borderColor: 'purple', borderDash: [2, 2], hidden: savedVisibility['MA (30D)'] === false },
            { label: `Funding Rate (${token})`, data: fundingValues, borderColor: lineColor, fill: false, hidden: savedVisibility['Funding Rate'] === false },
          ].map(d => Object.assign({
            fill: false,
            tension: 0.2,
            pointRadius: 0,
          }, d));

          const ctx = document.getElementById('fundingChart').getContext('2d');
          if (fundingChart) fundingChart.destroy();

          fundingChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(precision)}%`,
                  }
                },
                legend: {
                  labels: { color: textColor },
                  onClick: (e, item, legend) => {
                    const chart = legend.chart;
                    const meta = chart.getDatasetMeta(item.datasetIndex);
                    meta.hidden = meta.hidden === null ? !chart.data.datasets[item.datasetIndex].hidden : null;
                    chart.update();
                    const vis = {};
                    chart.data.datasets.forEach((ds, i) => {
                      const labelKey = ds.label.startsWith('Funding Rate') ? 'Funding Rate' : ds.label;
                      vis[labelKey] = chart.isDatasetVisible(i);
                    });
                    localStorage.setItem('datasetVisibility', JSON.stringify(vis));
                    syncDatasetCheckboxes();
                  }
                }
              },
              scales: {
                x: { ticks: { color: textColor }, grid: { color: gridColor } },
                y: {
                  ticks: { callback: v => `${v.toFixed(precision)}%`, color: textColor },
                  grid: { color: gridColor }
                }
              }
            }
          });
        } catch (err) {
          alert('Error loading funding data');
          console.error(err);
        } finally {
          toggleSpinner(false);
        }
      }

      // Moving average calculation
      function calculateMovingAverage(timeSeries, values, windowMs) {
        const result = [];
        let windowSum = 0, windowCount = 0, windowStartIdx = 0;

        for (let i = 0; i < timeSeries.length; i++) {
          const currentTime = timeSeries[i];
          while (timeSeries[windowStartIdx] < currentTime - windowMs) {
            windowSum -= values[windowStartIdx];
            windowCount--;
            windowStartIdx++;
          }
          windowSum += values[i];
          windowCount++;
          result.push(windowCount > 0 ? windowSum / windowCount : null);
        }
        return result;
      }

      // Filter MA arrays to visible timestamps
      function filterVisibleMovingAverage(fullTimes, fullMA, visibleTimes) {
        return fullTimes.map((t, i) => visibleTimes.includes(t) ? fullMA[i] : null).filter(val => val !== null);
      }

      // Spinner toggle
      function toggleSpinner(isVisible) {
        document.getElementById('spinnerOverlay').style.display = isVisible ? 'flex' : 'none';
      }

      // Apply quick date range
      function applyQuickRange(rangeKey) {
        const now = new Date();
        const start = new Date(now);
        const daysMap = { '1d': 1, '3d': 3, '7d': 7, '30d': 30 };
        start.setDate(now.getDate() - (daysMap[rangeKey] || 7));

        const toStr = d => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('customStart').value = toStr(start);
        document.getElementById('customEnd').value = toStr(now);

        localStorage.setItem('customStart', toStr(start));
        localStorage.setItem('customEnd', toStr(now));

        loadFundingData('custom');
      }

      // ===================
      // Window Onload
      // ===================

      window.onload = async () => {
        const savedToken = localStorage.getItem('selectedToken');
        if (savedToken) {
          selectedToken = savedToken;
          document.getElementById('selectedTokenLabel').innerText = savedToken;
        }

        await fetchAndRenderTokens();

        if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark');
          document.getElementById('themeToggle').textContent = '☀️';
        }

        const savedViewMode = localStorage.getItem('viewMode') || 'hourly';
        document.getElementById('selectedViewModeLabel').innerText = savedViewMode.charAt(0).toUpperCase() + savedViewMode.slice(1);

        buildDatasetDropdown();
        loadFundingData('custom');
      };
      </script>
   </body>
</html>
