<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <title>Funding History Viewer</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <style>
         :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --card-color: #ffffff;
            --input-bg: #ffffff;
            --input-border: #000000;
            --button-bg: #008b20;
            --button-hover: #005815;
            --chart-line: #3f8d00;
            --bg-overlay: #e1e1e1bf;
            --box-shadow: rgba(0, 0, 0, 0.6);
            --chart-text: #000000;
            --grid-color: rgba(0, 0, 0, 0.1);
         }
         body.dark {
            --bg-color: #000000;
            --text-color: #ffffff;
            --card-color: #000000;
            --input-bg: #000000;
            --input-border: #ffffff;
            --button-bg: #008b20;
            --button-hover: #005815;
            --chart-line: #3f8d00;
            --bg-overlay: #1e1e1ebf;
            --box-shadow: rgba(255, 255, 255, 0.6);
            --chart-text: #ffffff;
            --grid-color: rgba(255, 255, 255, 0.2);
         }
         body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            max-width: 1000px;
            margin: auto;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
         }
         h2 {
            margin-bottom: 1.5rem;
         }
         .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            user-select: none;
         }
         .controls {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            background: var(--card-color);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px var(--box-shadow);
            margin-bottom: 2rem;
         }
         .row {
            display: flex;
            gap: 2rem;
            align-items: flex-end;
         }
         .row.vertical-stack {
            flex-direction: column;
            gap: 2rem;
            align-items: center;
         }
         .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
         }
         .quick-range,
         .custom-range {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            text-align: center;
         }
         .custom-range button {
            display: flex;
            width: 80%;
         }
         .quick-buttons {
            display: grid;
            /* default: 4 in a row */
            grid-template-columns: repeat(4, 1fr); 
            gap: 1rem;
            width: 100%;
            margin-top: 0.5rem;
         }
         /* Medium screens: 2 per row */
         @media (max-width: 768px) {
         .quick-buttons {
         grid-template-columns: repeat(2, 1fr);
         }
         }
         /* Small screens: 1 per row */
         @media (max-width: 480px) {
         .quick-buttons {
            grid-template-columns: 1fr;
         }
         }
         .quick-buttons button {
            width: 100%;
         }
         .custom-range-inputs {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            width: 100%;
         }
         .custom-range-inputs input {
            min-width: 160px;
            width: 40%;
            justify-content: center;
         }
         .custom-range button {
            margin-top: 1rem;
            width: 85%;
            justify-content: center;
         }
         input, select, button {
            padding: 0.6rem;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 6px;
         }
         button {
            background-color: var(--button-bg);
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
         }
         button:hover {
            background-color: var(--button-hover);
         }
         canvas {
            max-width: 100%;
         }
         .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            background-color: var(--bg-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
         }
         .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--button-bg);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
         }
         @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
         }
         .ma-stats-table {
            width: 100%;
            margin: 1.5rem 0;
            font-size: 0.95rem;
         }
         .ma-stats-table table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            background-color: var(--card-color);
            border: 1px solid var(--input-border);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px var(--box-shadow);
         }
         .ma-stats-table th,
         .ma-stats-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--input-border);
         }
         .ma-stats-table th {
            background-color: var(--card-bg-hover);
            font-weight: 600;
         }
         #maStatsTable-MA-Range {
            border-color: red;
         }
         #maStatsTable-MA-24h {
            border-color: orange;
         }
         #maStatsTable-MA-3D {
            border-color: blue;
         }
         #maStatsTable-MA-7D {
           border-color: pink;
         }
         #maStatsTable-MA-30D {
           border-color: purple;
         }
         .ma-footnote {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            text-align: right;
            opacity: 0.7;
         }
      </style>
   </head>
   <body>
      <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">üåô</div>
      <h2>Hyperliquid Funding History</h2>
      <div id="spinnerOverlay" class="spinner-overlay">
         <div class="spinner"></div>
      </div>
      <div class="controls">
         <div class="row">
            <div class="control-group">
               <label for="tokenSelect"><strong>Select Token:</strong></label>
               <select id="tokenSelect"></select>
            </div>
            <div class="control-group">
               <label for="viewMode"><strong>View Mode:</strong></label>
               <select id="viewMode">
                  <option value="hourly">Hourly</option>
                  <option value="annualized">Annualized</option>
               </select>
            </div>
         </div>
         <div class="row vertical-stack">
            <div class="quick-range">
               <label><strong>Quick Ranges:</strong></label>
               <div class="quick-buttons">
                  <button onclick="applyQuickRange('1d')">Last 24 Hours</button>
                  <button onclick="applyQuickRange('3d')">Last 3 Days</button>
                  <button onclick="applyQuickRange('7d')">Last 7 Days</button>
                  <button onclick="applyQuickRange('30d')">Last 30 Days</button>
               </div>
            </div>
            <div class="custom-range">
               <label><strong>Custom Range:</strong></label>
               <div class="custom-range-inputs">
                  <input type="datetime-local" id="customStart" />
                  <span>-</span>
                  <input type="datetime-local" id="customEnd" />
               </div>
               <button onclick="loadFundingData('custom')">Load</button>
            </div>
         </div>
      </div>
      <div id="maStatsTable" class="ma-stats-table">
         <table>
            <thead>
               <tr>
                  <th id="maStatsTable-MA-Range">MA (Range)</th>
                  <th id="maStatsTable-MA-24h">MA (24h)</th>
                  <th id="maStatsTable-MA-3D">MA (3D)</th>
                  <th id="maStatsTable-MA-7D">MA (7D)</th>
                  <th id="maStatsTable-MA-30D">MA (30D)</th>
               </tr>
            </thead>
            <tbody>
               <tr id="maValuesRow"></tr>
            </tbody>
         </table>
         <div class="ma-footnote">* MA = Moving Average</div>
      </div>
      <canvas id="fundingChart" width="800" height="400"></canvas>
      <script>
         let fundingChart;
         
         // Converts Date to local ISO string suitable for datetime-local inputs
         function toLocalDateTimeString(date) {
           const offsetMinutes = date.getTimezoneOffset();
           const localDate = new Date(date.getTime() - offsetMinutes * 60000);
           return localDate.toISOString().slice(0, 16);
         }
         
         // Toggle theme between light and dark, persist choice, update toggle icon and reload data
         function toggleTheme() {
           const isDark = document.body.classList.toggle('dark');
           localStorage.setItem('theme', isDark ? 'dark' : 'light');
           document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
           if (fundingChart) {
             loadFundingData('custom');
           }
         }
         
         // Show or hide the spinner overlay
         function toggleSpinner(isVisible) {
           document.getElementById('spinnerOverlay').style.display = isVisible ? 'flex' : 'none';
         }
         
         // Load tokens from API and populate the select box
         async function loadTokens() {
           try {
             const response = await fetch('https://api.hyperliquid.xyz/info', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ type: 'meta' }),
             });
             const meta = await response.json();
             const tokensSorted = meta.universe.map(token => token.name).sort();
         
             const tokenSelect = document.getElementById('tokenSelect');
             tokenSelect.innerHTML = '';
             tokensSorted.forEach(tokenName => {
               const option = document.createElement('option');
               option.value = tokenName;
               option.textContent = tokenName;
               tokenSelect.appendChild(option);
             });
         
             const savedToken = localStorage.getItem('selectedToken') || 'ETH';
             tokenSelect.value = savedToken;
           } catch (error) {
             alert('Failed to load tokens');
             console.error(error);
           }
         }
         
         // Apply a predefined quick range and update date inputs and localStorage, then load data
         function applyQuickRange(rangeKey) {
           const now = new Date();
           const start = new Date(now);
         
           const daysMap = { '1d': 1, '3d': 3, '7d': 7, '30d': 30 };
           const days = daysMap[rangeKey] || 7;
         
           start.setDate(now.getDate() - days);
         
           const startStr = toLocalDateTimeString(start);
           const endStr = toLocalDateTimeString(now);
         
           document.getElementById('customStart').value = startStr;
           document.getElementById('customEnd').value = endStr;
         
           localStorage.setItem('customStart', startStr);
           localStorage.setItem('customEnd', endStr);
         
           loadFundingData('custom');
         }
         
         // Calculates moving average for given data and window duration
         function calculateMovingAverage(timeSeries, values, windowMs) {
           const result = [];
           let windowSum = 0;
           let windowCount = 0;
           let windowStartIdx = 0;
         
           for (let i = 0; i < timeSeries.length; i++) {
             const currentTime = timeSeries[i];
         
             // Move window start forward while outside window
             while (timeSeries[windowStartIdx] < currentTime - windowMs) {
               windowSum -= values[windowStartIdx];
               windowCount--;
               windowStartIdx++;
             }
         
             windowSum += values[i];
             windowCount++;
             result.push(windowCount > 0 ? windowSum / windowCount : null);
           }
           return result;
         }
         
         // Filters and matches moving average data to visible timestamps
         function filterVisibleMovingAverage(fullTimeSeries, fullMA, visibleTimes) {
           return fullTimeSeries.map((t, i) => visibleTimes.includes(t) ? fullMA[i] : null)
                                .filter(val => val !== null);
         }
         
         // Main function to load funding data and render chart & stats table
         async function loadFundingData(range = '7d') {
           const token = document.getElementById('tokenSelect').value;
           const viewMode = document.getElementById('viewMode').value;
           const precision = (viewMode === 'annualized') ? 2 : 4;
         
           // Save user preferences
           localStorage.setItem('selectedToken', token);
           localStorage.setItem('viewMode', viewMode);
         
           let startTime, endTime = Date.now();
         
           // Handle range input
           if (range === 'custom') {
             const startStr = document.getElementById('customStart').value;
             const endStr = document.getElementById('customEnd').value;
         
             if (!startStr || !endStr) {
               alert('Please select both start and end dates.');
               return;
             }
         
             startTime = new Date(startStr).getTime();
             endTime = new Date(endStr).getTime();
         
             if (startTime >= endTime) {
               alert('Start time must be before end time.');
               return;
             }
         
             // Save chosen custom range
             localStorage.setItem('customStart', startStr);
             localStorage.setItem('customEnd', endStr);
           } else {
             // If not custom, apply quick range and exit as it triggers this function again
             applyQuickRange(range);
             return;
           }
         
           // Add buffer days for moving averages (extra 30 days)
           const bufferMs = 30 * 24 * 60 * 60 * 1000;
           const fetchStartTime = startTime - bufferMs;
         
           // API limit chunk size ~20 days per request, split if necessary
           const maxChunkMs = 20 * 24 * 60 * 60 * 1000;
           const chunks = [];
           for (let chunkStart = fetchStartTime; chunkStart < endTime; chunkStart += maxChunkMs) {
             chunks.push([chunkStart, Math.min(chunkStart + maxChunkMs, endTime)]);
           }
         
           toggleSpinner(true);
           try {
             const fetches = chunks.map(([start, end]) => fetch('https://api.hyperliquid.xyz/info', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                 type: 'fundingHistory',
                 coin: token,
                 startTime: start,
                 endTime: end,
               }),
             }).then(res => res.json()));
         
             const chunkDataArrays = await Promise.all(fetches);
             const combinedData = chunkDataArrays.flat()
                                                .sort((a, b) => a.time - b.time);
         
             // Filter data to visible requested range
             const visibleData = combinedData.filter(d => d.time >= startTime && d.time <= endTime);
         
             // Prepare labels and funding rate values
             const labels = visibleData.map(item => new Date(item.time).toLocaleString());
             let fundingValues = visibleData.map(item => parseFloat(item.fundingRate) * 100);
         
             // Annualize if needed
             if (viewMode === 'annualized') {
               fundingValues = fundingValues.map(val => val * 24 * 365);
             }
         
             // Calculate cumulative moving average (CMA) on visible data
             const cumulativeMovingAvg = fundingValues.reduce((acc, val, idx) => {
               const newSum = (acc.sum || 0) + val;
               acc.movingAvg.push(newSum / (idx + 1));
               acc.sum = newSum;
               return acc;
             }, { movingAvg: [], sum: 0 }).movingAvg;
         
             // Prepare arrays for full data funding rate values for moving average windows
             const fullFundingValues = combinedData.map(item => {
               const rate = parseFloat(item.fundingRate);
               return viewMode === 'annualized' ? rate * 100 * 24 * 365 : rate * 100;
             });
             const fullTimestamps = combinedData.map(item => item.time);
         
             // Calculate moving averages for different windows
             const ma24h = calculateMovingAverage(fullTimestamps, fullFundingValues, 24 * 60 * 60 * 1000);
             const ma3d = calculateMovingAverage(fullTimestamps, fullFundingValues, 3 * 24 * 60 * 60 * 1000);
             const ma7d = calculateMovingAverage(fullTimestamps, fullFundingValues, 7 * 24 * 60 * 60 * 1000);
             const ma30d = calculateMovingAverage(fullTimestamps, fullFundingValues, 30 * 24 * 60 * 60 * 1000);
         
             // Find last visible index in full data for final MA values
             const lastVisibleIndex = fullTimestamps.findLastIndex(t => t <= endTime);
         
             // Final MAs to show in stats table
             const finalMAs = {
               'MA (Range)': cumulativeMovingAvg[cumulativeMovingAvg.length - 1],
               'MA (24h)': ma24h[lastVisibleIndex],
               'MA (3D)': ma3d[lastVisibleIndex],
               'MA (7D)': ma7d[lastVisibleIndex],
               'MA (30D)': ma30d[lastVisibleIndex],
             };
         
             // Update stats table row with formatted MAs
             const maRow = document.getElementById('maValuesRow');
             maRow.innerHTML = Object.values(finalMAs)
               .map(val => `<td>${val?.toFixed(precision)}%</td>`)
               .join('');
         
             // Filter moving averages to only visible timestamps
             const visibleTimes = visibleData.map(d => d.time);
             const filteredMA24h = filterVisibleMovingAverage(fullTimestamps, ma24h, visibleTimes);
             const filteredMA3d = filterVisibleMovingAverage(fullTimestamps, ma3d, visibleTimes);
             const filteredMA7d = filterVisibleMovingAverage(fullTimestamps, ma7d, visibleTimes);
             const filteredMA30d = filterVisibleMovingAverage(fullTimestamps, ma30d, visibleTimes);
         
             // Prepare chart datasets and their styling
             const style = getComputedStyle(document.body);
             const lineColor = style.getPropertyValue('--chart-line').trim();
             const textColor = style.getPropertyValue('--chart-text').trim();
             const gridColor = style.getPropertyValue('--grid-color').trim();
         
             // Load saved dataset visibility from localStorage
             const savedVisibility = JSON.parse(localStorage.getItem('datasetVisibility') || '{}');
         
             const datasets = [
               {
                 label: 'MA (Range)',
                 data: cumulativeMovingAvg,
                 borderColor: 'red',
                 borderDash: [4, 2],
                 fill: false,
                 tension: 0.1,
                 pointRadius: 0,
                 hidden: savedVisibility['MA (Range)'] === false,
               },
               {
                 label: 'MA (24h)',
                 data: filteredMA24h,
                 borderColor: 'orange',
                 borderDash: [2, 2],
                 fill: false,
                 tension: 0.1,
                 pointRadius: 0,
                 hidden: savedVisibility['MA (24h)'] === false,
               },
               {
                 label: 'MA (3D)',
                 data: filteredMA3d,
                 borderColor: 'blue',
                 borderDash: [2, 2],
                 fill: false,
                 tension: 0.1,
                 pointRadius: 0,
                 hidden: savedVisibility['MA (3D)'] === false,
               },
               {
                 label: 'MA (7D)',
                 data: filteredMA7d,
                 borderColor: 'pink',
                 borderDash: [2, 2],
                 fill: false,
                 tension: 0.1,
                 pointRadius: 0,
                 hidden: savedVisibility['MA (7D)'] === false,
               },
               {
                 label: 'MA (30D)',
                 data: filteredMA30d,
                 borderColor: 'purple',
                 borderDash: [2, 2],
                 fill: false,
                 tension: 0.1,
                 pointRadius: 0,
                 hidden: savedVisibility['MA (30D)'] === false,
               },
               {
                 label: `Funding Rate (${token})`,
                 data: fundingValues,
                 borderColor: lineColor,
                 fill: false,
                 tension: 0.2,
                 hidden: savedVisibility['Funding Rate'] === false,
               },
             ];
         
             // Initialize or update Chart.js chart
             const ctx = document.getElementById('fundingChart').getContext('2d');
             if (fundingChart) {
               fundingChart.destroy();
             }
         
             fundingChart = new Chart(ctx, {
               type: 'line',
               data: { labels, datasets },
               options: {
                 responsive: true,
                 plugins: {
                   tooltip: {
                     callbacks: {
                       label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(precision)}%`,
                     },
                   },
                   legend: {
                     labels: { color: textColor },
                     onClick: (event, legendItem, legend) => {
                       const chartInstance = legend.chart;
                       const datasetIndex = legendItem.datasetIndex;
                       const meta = chartInstance.getDatasetMeta(datasetIndex);
         
                       // Toggle dataset visibility
                       meta.hidden = meta.hidden === null ? !chartInstance.data.datasets[datasetIndex].hidden : null;
                       chartInstance.update();
         
                       // Save visibility states in localStorage
                       const visibilityStates = {};
                       chartInstance.data.datasets.forEach((ds, i) => {
                         const labelKey = ds.label.startsWith('Funding Rate') ? 'Funding Rate' : ds.label;
                         visibilityStates[labelKey] = chartInstance.isDatasetVisible(i);
                       });
                       localStorage.setItem('datasetVisibility', JSON.stringify(visibilityStates));
                     },
                   },
                 },
                 scales: {
                   x: {
                     ticks: { color: textColor },
                     grid: { color: gridColor },
                   },
                   y: {
                     ticks: {
                       callback: val => `${val.toFixed(precision)}%`,
                       color: textColor,
                     },
                     grid: { color: gridColor },
                   },
                 },
               },
             });
           } catch (error) {
             alert('Error loading funding data');
             console.error(error);
           } finally {
             toggleSpinner(false);
           }
         }
         
         // Initialize app state on load
         window.onload = async () => {
           // Apply saved theme preference
           if (localStorage.getItem('theme') === 'dark') {
             document.body.classList.add('dark');
             document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
           }
         
           await loadTokens();
         
           // Restore view mode and custom date range inputs from localStorage
           const savedViewMode = localStorage.getItem('viewMode');
           if (savedViewMode) {
             document.getElementById('viewMode').value = savedViewMode;
           }
           const savedStart = localStorage.getItem('customStart');
           const savedEnd = localStorage.getItem('customEnd');
           if (savedStart) {
             document.getElementById('customStart').value = savedStart;
           }
           if (savedEnd) {
             document.getElementById('customEnd').value = savedEnd;
           }
         
           // Load data for the custom range on startup
           loadFundingData('custom');
         };
         
         // Persist token selection
         document.getElementById('tokenSelect').addEventListener('change', e => {
           localStorage.setItem('selectedToken', e.target.value);
         });
         
         // Persist view mode selection and reload data on change
         document.getElementById('viewMode').addEventListener('change', e => {
           localStorage.setItem('viewMode', e.target.value);
           loadFundingData('custom');
         });
      </script>
   </body>
</html>